<!DOCTYPE html>
<html>
<head>
    <title>WebXR AR Border Frame</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
</head>
<body>
    <button id="startAR" style="position: fixed; top: 20px; right: 20px; z-index: 100;">Start AR</button>
    <script>
        let camera, scene, renderer;
        let frame;

        init();

        function init() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 20);
            
            renderer = new THREE.WebGLRenderer({ 
                antialias: true,
                alpha: true
            });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.xr.enabled = true;
            document.body.appendChild(renderer.domElement);

            // Create frame geometry
            const frameGeometry = new THREE.PlaneGeometry(1, 1.5);
            
            // Load the border texture
            const textureLoader = new THREE.TextureLoader();
            const borderTexture = textureLoader.load('https://github.com/laithi/arjstest/blob/50d5e954ca5bd210460589fceba8a68fe17f751a/pngtree-abstract-fluid-instagram-story-border-png-image_6243695.jpg');
            
            const frameMaterial = new THREE.MeshBasicMaterial({
                map: borderTexture,
                transparent: true,
                opacity: 0.8,
                side: THREE.DoubleSide
            });

            frame = new THREE.Mesh(frameGeometry, frameMaterial);
            frame.position.z = -1.5;
            scene.add(frame);

            // Set up AR button
            const arButton = document.getElementById('startAR');
            arButton.addEventListener('click', onStartAR);

            window.addEventListener('resize', onWindowResize, false);
        }

        async function onStartAR() {
            if (!navigator.xr) {
                alert("WebXR not available");
                return;
            }

            try {
                // Simplified AR session request
                const session = await navigator.xr.requestSession('immersive-ar', {
                    optionalFeatures: ['dom-overlay'],
                    domOverlay: { root: document.body }
                });

                await renderer.xr.setSession(session);
                session.addEventListener('end', onSessionEnd);
                
                // Try to get viewer reference space
                try {
                    const referenceSpace = await session.requestReferenceSpace('viewer');
                    renderer.xr.setReferenceSpace(referenceSpace);
                } catch (e) {
                    // If viewer space fails, try local space
                    try {
                        const referenceSpace = await session.requestReferenceSpace('local');
                        renderer.xr.setReferenceSpace(referenceSpace);
                    } catch (e) {
                        console.error('Failed to get any reference space');
                    }
                }

                renderer.setAnimationLoop(render);
            } catch (err) {
                console.error('Failed to start AR session:', err);
                alert("Error starting AR session: " + err.message);
            }
        }

        function onSessionEnd() {
            renderer.setAnimationLoop(null);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function render(timestamp, frame) {
            if (frame) {
                const session = renderer.xr.getSession();
                if (session) {
                    const referenceSpace = renderer.xr.getReferenceSpace();
                    if (referenceSpace) {
                        const pose = frame.getViewerPose(referenceSpace);
                        if (pose) {
                            const view = pose.views[0];
                            if (view) {
                                // Update frame to follow camera
                                frame.position.set(0, 0, -1.5);
                                frame.rotation.copy(camera.rotation);
                            }
                        }
                    }
                }
            }
            
            renderer.render(scene, camera);
        }

        // Check AR availability
        if (navigator.xr) {
            navigator.xr.isSessionSupported('immersive-ar')
                .then((supported) => {
                    if (!supported) {
                        document.getElementById('startAR').disabled = true;
                        document.getElementById('startAR').textContent = 'AR NOT SUPPORTED';
                    }
                });
        } else {
            document.getElementById('startAR').disabled = true;
            document.getElementById('startAR').textContent = 'WebXR NOT AVAILABLE';
        }
    </script>
</body>
</html>
