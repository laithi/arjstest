<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Simple Three.js WebAR</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <style>
        body { 
            margin: 0; 
            overflow: hidden; 
        }
        #debug-info {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px;
            font-family: monospace;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div id="debug-info">Initializing...</div>

    <script type="module">
        import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.157.0/build/three.module.js';
        import { GLTFLoader } from 'https://cdn.jsdelivr.net/npm/three@0.157.0/examples/jsm/loaders/GLTFLoader.js';
        import { ARButton } from 'https://cdn.jsdelivr.net/npm/three@0.157.0/examples/jsm/webxr/ARButton.js';

        const debugInfo = document.getElementById('debug-info');
        function updateDebug(text) {
            debugInfo.innerHTML += '<br>' + text;
            console.log(text);
        }

        let camera, scene, renderer, model;

        // First, check if WebXR is available
        if (!navigator.xr) {
            updateDebug('WebXR not supported');
            throw new Error('WebXR not supported');
        }

        updateDebug('WebXR found, checking AR support...');

        navigator.xr.isSessionSupported('immersive-ar')
            .then((supported) => {
                if (supported) {
                    updateDebug('AR is supported');
                    init();
                } else {
                    updateDebug('AR not supported on this device');
                }
            })
            .catch(err => {
                updateDebug('Error checking AR support: ' + err);
            });

        function init() {
            updateDebug('Initializing...');

            // Scene setup
            scene = new THREE.Scene();
            updateDebug('Scene created');

            // Camera setup
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            updateDebug('Camera created');

            // Renderer setup
            renderer = new THREE.WebGLRenderer({
                antialias: true,
                alpha: true
            });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.xr.enabled = true;
            document.body.appendChild(renderer.domElement);
            updateDebug('Renderer created');

            // Add simple cube as test object
            const geometry = new THREE.BoxGeometry(0.2, 0.2, 0.2);
            const material = new THREE.MeshBasicMaterial({ color: 0x00ff00 });
            const cube = new THREE.Mesh(geometry, material);
            cube.position.set(0, 0, -1);
            scene.add(cube);
            updateDebug('Test cube added');

            // Lights
            const light = new THREE.AmbientLight(0xffffff);
            scene.add(light);
            updateDebug('Lights added');

            try {
                const arButton = ARButton.createButton(renderer, {
                    requiredFeatures: ['hit-test'],
                    optionalFeatures: ['dom-overlay'],
                    domOverlay: { root: document.body }
                });
                document.body.appendChild(arButton);
                updateDebug('AR button created');
            } catch (error) {
                updateDebug('Error creating AR button: ' + error);
            }

            // Load Model
            const loader = new GLTFLoader();
            loader.load(
                'https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/master/2.0/Duck/glTF/Duck.gltf',
                function(gltf) {
                    model = gltf.scene;
                    model.scale.set(0.1, 0.1, 0.1);
                    scene.add(model);
                    updateDebug('Model loaded successfully');
                },
                function(xhr) {
                    updateDebug('Loading model: ' + (xhr.loaded / xhr.total * 100) + '%');
                },
                function(error) {
                    updateDebug('Error loading model: ' + error);
                }
            );

            animate();
            updateDebug('Animation loop started');
        }

        function animate() {
            renderer.setAnimationLoop(function() {
                renderer.render(scene, camera);
            });
        }

        // Handle window resizing
        window.addEventListener('resize', function() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
