<!DOCTYPE html>
<html>
<head>
    <title>WebAR 3D Model Viewer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Update to latest versions of libraries -->
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
        }
        #placeButton {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 20px;
            background: #fff;
            border: none;
            border-radius: 5px;
            z-index: 100;
        }
        .ar-overlay {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px;
            border-radius: 5px;
            z-index: 100;
            text-align: center;
        }
    </style>
</head>
<body>
    <div id="instructions" class="ar-overlay">Waiting for camera permission...</div>
    <button id="placeButton" style="display: none;">Place 3D Model</button>

    <!-- Modified A-Frame scene setup -->
    <a-scene 
        embedded
        arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;"
        renderer="logarithmicDepthBuffer: true;"
        vr-mode-ui="enabled: false">

        <!-- Define assets -->
        <a-assets>
            <a-asset-item id="model" src="https://github.com/laithi/arjstest/blob/main/future%20museum.gltf"></a-asset-item>
        </a-assets>

        <!-- Camera -->
        <a-entity camera></a-entity>

        <!-- 3D Model -->
        <a-entity 
            id="ar-model"
            gltf-model="#model"
            position="0 0 0"
            scale="0.1 0.1 0.1"
            rotation="0 0 0"
            visible="false">
        </a-entity>
    </a-scene>

    <script>
        window.onload = function() {
            const model = document.getElementById('ar-model');
            const placeButton = document.getElementById('placeButton');
            const instructions = document.getElementById('instructions');
            let isPlaced = false;

            // Check for WebXR support
            if (navigator.xr) {
                navigator.xr.isSessionSupported('immersive-ar')
                    .then((supported) => {
                        if (supported) {
                            instructions.textContent = 'WebXR AR Supported. Initializing...';
                        } else {
                            instructions.textContent = 'WebXR AR not supported on this device';
                        }
                    });
            }

            // Handle camera initialization
            const scene = document.querySelector('a-scene');
            
            scene.addEventListener('loaded', function () {
                instructions.textContent = 'Scene loaded. Waiting for camera...';
            });

            scene.addEventListener('camera-init', function () {
                instructions.textContent = 'Camera initialized. Please allow camera access.';
            });

            // When everything is ready
            scene.addEventListener('arjs-video-loaded', function () {
                instructions.textContent = 'Point your camera at a flat surface';
                placeButton.style.display = 'block';
            });

            // Error handling for camera
            scene.addEventListener('camera-error', function (error) {
                console.error('Camera error:', error);
                instructions.innerHTML = 'Camera error! Please:<br>1. Ensure camera permissions are granted<br>2. Use HTTPS<br>3. Use a modern browser (Chrome/Safari)';
            });

            // Place button functionality
            placeButton.addEventListener('click', function() {
                if (!isPlaced) {
                    model.setAttribute('visible', true);
                    
                    // Get camera position
                    const camera = document.querySelector('[camera]');
                    const worldPos = new THREE.Vector3();
                    camera.object3D.getWorldPosition(worldPos);
                    
                    // Place model 2 meters in front of camera
                    const rotation = camera.object3D.rotation;
                    const distance = 2;
                    const x = worldPos.x - Math.sin(rotation.y) * distance;
                    const z = worldPos.z - Math.cos(rotation.y) * distance;
                    
                    model.setAttribute('position', `${x} 0 ${z}`);
                    model.setAttribute('rotation', '0 ' + (rotation.y * 180 / Math.PI) + ' 0');
                    
                    isPlaced = true;
                    placeButton.textContent = 'Adjust Model';
                    instructions.textContent = 'Model placed! Walk around to view it';
                }
            });

            // Add touch/click interaction for the model
            model.addEventListener('click', function() {
                if (isPlaced) {
                    const currentScale = model.getAttribute('scale');
                    const newScale = currentScale.x * 1.2;
                    model.setAttribute('scale', `${newScale} ${newScale} ${newScale}`);
                }
            });
        };

        // Additional check for HTTPS
        if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost') {
            document.getElementById('instructions').innerHTML = 
                'ERROR: This page must be accessed over HTTPS for camera access.<br>Please use HTTPS or localhost.';
        }
    </script>
</body>
</html>
