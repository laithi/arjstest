<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تأثير WebXR للمكياج الافتراضي</title>
    <style>
        /* styles.css */
        body, html {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #000;
        }

        #video-container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }

        #video {
            position: absolute;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1); /* عكس الفيديو لجعل التجربة كمرآة */
        }

        #overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            transform: scaleX(-1); /* عكس اللوحة لتتوافق مع الفيديو */
        }
    </style>
    <!-- تحميل مكتبة three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- تحميل مكتبة MediaPipe -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
    <!-- تحميل مكتبة TensorFlow.js (اختياري إذا كنت تستخدم TensorFlow) -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.11.0/dist/tf.min.js"></script>
</head>
<body>
    <div id="video-container">
        <video id="video" autoplay playsinline></video>
        <canvas id="overlay"></canvas>
    </div>
    <script>
        // faceTracking.js

        class FaceTracker {
            constructor(onFaceDetected) {
                this.onFaceDetected = onFaceDetected;
                this.video = document.getElementById('video');
                this.overlay = document.getElementById('overlay');
                this.canvasCtx = this.overlay.getContext('2d');

                this.faceMesh = new FaceMesh.FaceMesh({
                    locateFile: (file) => {
                        return `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`;
                    }
                });

                this.faceMesh.setOptions({
                    maxNumFaces: 1,
                    refineLandmarks: true,
                    minDetectionConfidence: 0.5,
                    minTrackingConfidence: 0.5
                });

                this.faceMesh.onResults(this.onResults.bind(this));
            }

            async initCamera() {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'user' },
                    audio: false
                });
                this.video.srcObject = stream;
                return new Promise((resolve) => {
                    this.video.onloadedmetadata = () => {
                        this.video.play();
                        resolve();
                    };
                });
            }

            async start() {
                await this.initCamera();
                this.sendFrame();
            }

            sendFrame() {
                this.faceMesh.send({ image: this.video });
                requestAnimationFrame(this.sendFrame.bind(this));
            }

            onResults(results) {
                this.canvasCtx.save();
                this.canvasCtx.clearRect(0, 0, this.overlay.width, this.overlay.height);
                this.canvasCtx.drawImage(
                    results.image, 0, 0, this.overlay.width, this.overlay.height
                );

                if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
                    const landmarks = results.multiFaceLandmarks[0];
                    this.onFaceDetected(landmarks);
                }

                this.canvasCtx.restore();
            }
        }

        // makeupOverlay.js

        class MakeupOverlay {
            constructor() {
                this.overlay = document.getElementById('overlay');
                this.canvas = document.createElement('canvas');
                this.canvas.width = this.overlay.width;
                this.canvas.height = this.overlay.height;
                this.canvasCtx = this.canvas.getContext('2d');
            }

            applyMakeup(landmarks) {
                this.canvasCtx.clearRect(0, 0, this.canvas.width, this.canvas.height);

                // تطبيق أحمر الشفاه
                this.drawLipstick(landmarks);

                // تطبيق كحل العيون
                this.drawEyeliner(landmarks);

                // تطبيق أحمر الخدود
                this.drawBlush(landmarks);

                // دمج طبقة المكياج مع اللوحة الرئيسية
                this.overlay.getContext('2d').drawImage(this.canvas, 0, 0);
            }

            drawLipstick(landmarks) {
                // تحديد نقاط الشفاه
                const lipUpper = landmarks.slice(61, 80);
                const lipLower = landmarks.slice(81, 100);

                this.canvasCtx.fillStyle = 'rgba(255, 0, 0, 0.6)'; // أحمر شفاف

                this.canvasCtx.beginPath();
                lipUpper.forEach((point, index) => {
                    const x = point.x * this.canvas.width;
                    const y = point.y * this.canvas.height;
                    if (index === 0) this.canvasCtx.moveTo(x, y);
                    else this.canvasCtx.lineTo(x, y);
                });

                lipLower.forEach((point, index) => {
                    const x = point.x * this.canvas.width;
                    const y = point.y * this.canvas.height;
                    this.canvasCtx.lineTo(x, y);
                });

                this.canvasCtx.closePath();
                this.canvasCtx.fill();
            }

            drawEyeliner(landmarks) {
                // تحديد نقاط العيون (هذه نقاط تقريبية وقد تحتاج لتعديل بناءً على مكتبة المعالم)
                const leftEye = landmarks.slice(33, 133); // نقاط العين اليسرى
                const rightEye = landmarks.slice(263, 362); // نقاط العين اليمنى

                this.canvasCtx.strokeStyle = 'rgba(0, 0, 0, 0.8)'; // أسود شفاف
                this.canvasCtx.lineWidth = 2;

                this.drawEye(leftEye);
                this.drawEye(rightEye);
            }

            drawEye(eyeLandmarks) {
                this.canvasCtx.beginPath();
                eyeLandmarks.forEach((point, index) => {
                    const x = point.x * this.canvas.width;
                    const y = point.y * this.canvas.height;
                    if (index === 0) this.canvasCtx.moveTo(x, y);
                    else this.canvasCtx.lineTo(x, y);
                });
                this.canvasCtx.stroke();
            }

            drawBlush(landmarks) {
                // تحديد نقاط الخدود (هذه نقاط تقريبية وقد تحتاج لتعديل بناءً على مكتبة المعالم)
                const leftCheek = landmarks[234];
                const rightCheek = landmarks[454];

                this.canvasCtx.fillStyle = 'rgba(255, 105, 180, 0.5)'; // وردي شفاف

                // رسم دائرة بسيطة على الخدود
                this.canvasCtx.beginPath();
                this.canvasCtx.arc(leftCheek.x * this.canvas.width, leftCheek.y * this.canvas.height, 20, 0, 2 * Math.PI);
                this.canvasCtx.fill();

                this.canvasCtx.beginPath();
                this.canvasCtx.arc(rightCheek.x * this.canvas.width, rightCheek.y * this.canvas.height, 20, 0, 2 * Math.PI);
                this.canvasCtx.fill();
            }
        }

        // animation.js

        class LineAnimation {
            constructor() {
                this.overlay = document.getElementById('overlay');
                this.canvas = document.createElement('canvas');
                this.canvas.width = this.overlay.width;
                this.canvas.height = this.overlay.height;
                this.canvasCtx = this.canvas.getContext('2d');
                this.isAnimating = false;
                this.startTime = null;
            }

            start() {
                if (this.isAnimating) return;
                this.isAnimating = true;
                this.startTime = performance.now();
                requestAnimationFrame(this.animate.bind(this));
            }

            animate(timestamp) {
                if (!this.isAnimating) return;
                const elapsed = timestamp - this.startTime;
                if (elapsed > 2000) { // انتهاء بعد ثانيتين
                    this.isAnimating = false;
                    this.clear();
                    return;
                }

                const progress = (elapsed % 1000) / 1000; // دورة كل ثانية

                // حساب موضع الخط
                const y = this.canvas.height / 2 + 50 * Math.sin(progress * 2 * Math.PI);

                // رسم الخط
                this.canvasCtx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                this.canvasCtx.strokeStyle = 'rgba(255, 255, 255, 0.8)';
                this.canvasCtx.lineWidth = 2;
                this.canvasCtx.beginPath();
                this.canvasCtx.moveTo(0, y);
                this.canvasCtx.lineTo(this.canvas.width, y);
                this.canvasCtx.stroke();

                // دمج الخط مع اللوحة الرئيسية
                this.overlay.getContext('2d').drawImage(this.canvas, 0, 0);

                requestAnimationFrame(this.animate.bind(this));
            }

            clear() {
                this.canvasCtx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                this.overlay.getContext('2d').clearRect(0, 0, this.overlay.width, this.overlay.height);
            }
        }

        // main.js

        document.addEventListener('DOMContentLoaded', () => {
            const faceTracker = new FaceTracker(onFaceDetected);
            const makeupOverlay = new MakeupOverlay();
            const lineAnimation = new LineAnimation();

            faceTracker.start();

            function onFaceDetected(landmarks) {
                makeupOverlay.applyMakeup(landmarks);
                // بدء حركة الخط بعد التقاط الوجه
                lineAnimation.start();
            }

            // تحديث حجم اللوحات عند تغيير حجم النافذة
            window.addEventListener('resize', () => {
                const overlay = document.getElementById('overlay');
                overlay.width = window.innerWidth;
                overlay.height = window.innerHeight;

                // تحديث حجم اللوحات في MakeupOverlay و LineAnimation
                makeupOverlay.canvas.width = window.innerWidth;
                makeupOverlay.canvas.height = window.innerHeight;

                lineAnimation.canvas.width = window.innerWidth;
                lineAnimation.canvas.height = window.innerHeight;
            });

            // ضبط حجم اللوحات عند التحميل
            const overlay = document.getElementById('overlay');
            overlay.width = window.innerWidth;
            overlay.height = window.innerHeight;

            // ضبط حجم اللوحات في MakeupOverlay و LineAnimation
            makeupOverlay.canvas.width = window.innerWidth;
            makeupOverlay.canvas.height = window.innerHeight;

            lineAnimation.canvas.width = window.innerWidth;
            lineAnimation.canvas.height = window.innerHeight;
        });
    </script>
</body>
</html>
