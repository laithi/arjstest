<!DOCTYPE html>
<html>
  <head>
    <title>WebAR World Effect Cube</title>
    <!-- تضمين مكتبة A-Frame -->
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <!-- تضمين مكتبة AR لتطبيقات WebXR -->
    <script src="https://cdn.jsdelivr.net/npm/@ar-js-org/ar.js@3.3.2/aframe/build/aframe-ar-nft.js"></script>
  </head>
  <body style="margin: 0; overflow: hidden;">
    <!-- مشهد A-Frame مع خصائص WebXR -->
    <a-scene
      embedded
      vr-mode-ui="enabled: false"
      renderer="antialias: true; alpha: true"
      webxr="requiredFeatures: hit-test; optionalFeatures: local-floor, bounded-floor;"
    >
      <!-- مكعب يظهر في المساحة الحقيقية -->
      <a-box
        id="cube"
        visible="false"
        depth="0.5"
        height="0.5"
        width="0.5"
        color="#4CC3D9"
        animation="property: position; dir: alternate; dur: 1000; loop: true; to: 0 0.5 0"
        gesture-handler
      ></a-box>

      <!-- كاميرا -->
      <a-camera
        raycaster="objects: .clickable"
        cursor="fuse: false; rayOrigin: mouse;"
      ></a-camera>
    </a-scene>

    <!-- مكون لوضع الكائن على الأسطح المكتشفة -->
    <script>
      AFRAME.registerComponent('surface-placer', {
        init: function () {
          const scene = this.el.sceneEl;
          const cube = document.getElementById('cube');
          let hitTestSource = null;
          let viewerSpace = null;
          let xrSession = null;

          scene.renderer.xr.addEventListener('sessionstart', async () => {
            xrSession = scene.renderer.xr.getSession();
            const viewerSpace = await xrSession.requestReferenceSpace('viewer');
            hitTestSource = await xrSession.requestHitTestSource({ space: viewerSpace });
          });

          scene.addEventListener('click', (event) => {
            if (!hitTestSource) return;

            const frame = event.detail.frame;
            const referenceSpace = scene.renderer.xr.getReferenceSpace();
            const hitTestResults = frame.getHitTestResults(hitTestSource);

            if (hitTestResults.length > 0) {
              const hit = hitTestResults[0];
              const pose = hit.getPose(referenceSpace);
              cube.setAttribute('position', pose.transform.position);
              cube.setAttribute('visible', 'true');
            }
          });
        }
      });

      // إضافة المكون إلى المشهد
      document.querySelector('a-scene').setAttribute('surface-placer', '');
    </script>

    <!-- مكون Gesture Handler للتفاعل مع المكعب -->
    <script>
      AFRAME.registerComponent('gesture-handler', {
        init: function () {
          const cube = this.el;
          let isDragging = false;
          let startRotation = null;

          cube.addEventListener('mousedown', (e) => {
            isDragging = true;
            startRotation = cube.getAttribute('rotation');
          });

          window.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            let movementX = e.movementX;
            let rotation = {
              x: startRotation.x,
              y: startRotation.y + movementX * 0.5,
              z: startRotation.z
            };
            cube.setAttribute('rotation', rotation);
          });

          window.addEventListener('mouseup', () => {
            isDragging = false;
          });
        }
      });
    </script>
  </body>
</html>
